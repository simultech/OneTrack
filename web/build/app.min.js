/*! onetrackserver 2016-03-28 */
var express=require("express"),bodyParser=require("body-parser"),app=express();app.use(bodyParser.urlencoded({extended:!1})),app.use(bodyParser.json());var MongoClient=require("mongodb").MongoClient,assert=require("assert"),ObjectId=require("mongodb").ObjectID,url="mongodb://localhost:27017/onetrackdb",db,shortid=require("shortid");console.log(shortid.generate()),MongoClient.connect(url,function(a,b){assert.equal(null,a),console.log("***** Setting MongoDB ******"),db=b});var findRestaurants=function(a,b){var c=a.collection("restaurants").find();c.each(function(a,c){assert.equal(a,null),null!==c?console.dir(c):b()})};app.get("/",function(a,b){var c={apple:2,banana:10};b.json(c)}),app.post("/",function(a,b){b.send("Got a POST request")}),app.listen(3e3,function(){console.log("Example app listening on port 3000!"),console.log("test")}),app.post("/add_user",function(a,b){console.log("This is add_user request",a.body);var c=a.body;c.tracks=[];var d=function(b,d,e){b.collection("users").updateOne({fb_id:a.body.fb_id},c,{upsert:!0,safe:!1},function(a,b){null!==a?e(a):(console.log("Inserted a USER"),d())})};console.log("***** Insert into MongoDB ******"),d(db,function(){b.send({success:"true"})},function(a){b.send({success:"false",message:a})})}),app.post("/create_tracker",function(a,b){console.log("This is create_tracker request",a.body);var c=a.body;c.id=shortid.generate();var d=function(b,d,e){b.collection("users").update({fb_id:a.body.fb_id},{$push:{tracks:c}},function(a,b){null!==a?e(a):(console.log("Insertedk a Tracker Z"),d(c.id))})};console.log("***** Insert into MongoDB ******"),d(db,function(a){b.send({success:"true",id:a})},function(a){b.send({success:"false",message:a})})});